<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<script src="../js/mui.min.js"></script>
		<script src="../js/lib/flexible.js"></script>
		<script type="text/javascript" src="../js/lib/flexible_css.js" ></script>
		<script type="text/javascript" src="../js/lib/jquery-1.10.2.min.js" ></script>
		<link rel="stylesheet" type="text/css" href="../css/wt_house.css"/>
		<link rel="stylesheet" type="text/css" href="../css/style_a_d.css"/>
		<link rel="stylesheet" type="text/css" href="../css/a_fringe.css"/>
		<script src="../mypic/binaryajax.js" type="text/javascript" charset="utf-8"></script>
		<script src="../mypic/exif.js" type="text/javascript" charset="utf-8"></script>
		<script src="../mypic/canvasResize.js" type="text/javascript" charset="utf-8"></script>
	</head>
	<style type="text/css">
		.right_xz{
			position: absolute;
			top: 50%;
			margin-top: -0.213333rem;
			right: 0.4rem;
			color: #bbbbbb;
		}
		.wt_btnbox{margin: 1.733333rem auto 0;}
		/*取消输入框右侧圆圈清除按钮*/
		.fwxx .mui-input-row .mui-input-clear~.mui-icon-clear,.qynx .mui-input-row .mui-input-clear~.mui-icon-clear{
			display: none!important;
		}
		.btn_1,.btn_2{
			
        }
        .showimg {
        	display: flex;
        	justify-content: flex-start;
        	flex-wrap: wrap;
            text-align: center;
        }
        .add_img_btn{width: 2.053333rem;height: 2.053333rem;background: url(../img/repairs_pic/z_add.png)no-repeat center;background-size: 100% auto;margin: 0.133333rem 0.133333rem 0 0;}
		.up_img_phnoto{border: 0px solid #c8c8c8 !important;}
		.up_img{min-height: 3.2rem;height: auto;background-color: #ffffff;padding-left: 0.4rem;display: flex;padding-bottom: 0.4rem;justify-content: flex-start;flex-wrap: wrap;}
		.up_img_span{border: 1px solid #c8c8c8;display: flex;width: 2.053333rem;height: 2.053333rem;margin-top: 0.52rem;margin-right: 0.453333rem;}
		.up_img_span span{display: flex;align-items: center;justify-content: center;width: 100%;font-size: 2rem;color: #c8c8c8;}
		.del_pic{
			position: relative;
		}
		.del_pic_btn{
			position: absolute;
			top: 0;
			right: 0;
			z-index: 9;
			width: 0.533333rem;
			height: 0.533333rem;
			border-radius: 50%;
			overflow: hidden;
			background: #C7C7CC;
			font-size: 0.453333rem;
			color: #fff;
			text-align: center;
			transform: rotate(45deg);
		}
	</style>

	<body>
		<header class="mui-bar mui-bar-nav wd-header_p ipx_public_h1">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left a_d"></a>
		    <h1 class="mui-title">门窗维修</h1>
		</header>
		<div class="mui-content sy_ipx_content" style="bottom: 0;background: #f0f0f0;overflow: auto;">
		    <div class="wt_ms">
		    	<p>请留下您的房屋基本信息与联系方式，我们会及时与您联系，为您提供专属服务。</p>
		    </div>
		    <!--房屋信息-->
		    <div class="wt_fwxx fwxx">
		    	<div class="mui-input-row wt_inpsty">
		    	    <label>房屋信息</label>
		    	    <input type="text" class="mui-input-clear" placeholder="请选择楼盘名称及所在区域" id="house_news">
		    	    <span class="mui-icon mui-icon-arrowright right_xz"></span>
		    	</div>
		    </div>
		    <!--基本信息表单-->
		    <div class="wt_jbxx">
		    	<div class="mui-input-row wt_inpsty">
		    	    <label>姓名</label>
		    	    <input type="text" class="mui-input-clear" placeholder="请输入真实姓名" id="user_name">
		    	</div>
		    	<div class="mui-input-row wt_inpsty">
		    	    <label>手机号</label>
		    	    <input type="text" class="mui-input-clear" placeholder="请输入手机号" onkeyup="this.value=this.value.replace(/\D/g,'')"  onafterpaste="this.value=this.value.replace(/\D/g,'')" autocomplete="off" maxlength="11"  id="tel">
		    	    <span class="hqyzm">获取验证码</span>
		    	</div>
		    	<div class="mui-input-row wt_inpsty">
		    	    <label>验证码</label>
		    	    <input type="text" class="mui-input-clear" placeholder="请输入验证码" autocomplete="off" onkeyup="this.value=this.value.replace(/\D/g,'')"  onafterpaste="this.value=this.value.replace(/\D/g,'')" maxlength="6"  id="hqyzm">
		    	</div>
		    </div>
		    
		    <!--报修信息-->
		    <div class="wt_fwms" style="border-bottom:0px solid red !important;">
		    	<p class="wt_fwms_bt">报修信息</p>
		    	<p class="wt_texar">
		    		<textarea name="" rows="" cols="" placeholder="请输入详细内容" id="house_ms"></textarea>
		    		<span class="wt_texar_count"><i id="textareaCount">0</i>/200</span>
		    	</p>
		    </div>
		    <div class="up_img">
		    	<div class="showimg">
		    		<div class="add_img_btn" id="add_img"></div>
            	</div>
		    </div>
		    <!--底部-->
		    <div class="wt_bottom">
		    	<div class="wt_btnbox">
		    		<button class="wt_btn btn">提交</button>
		    	</div>
		    	<div class="wt_yw">
		    		<p class="wt_tip">如有任何疑问请拨打咨询电话</p>
		    		<p class="wt_tel"><a href="tel:400-078-8800" class="a_d">400-078-8800</a></p>
		    	</div>
		    </div>
		</div>
		<script src="../js/lib/app_config.js"></script>
	</body>
	<script>
		$(function(){  
			//控制文本域输入字数
	        $('textarea').keyup(function(event) {  
	            var maxLength = 200;  
	            var len = $('textarea').val().length;  
	            $('#textareaCount').html(len);  
	            if(parseInt($('#textareaCount').text()) > 200){  
	                $('#textareaCount').html('200');  
	                var res = $(this).val().substring(0,200);  
	                $(this).val(res);  
	            }  
	        });  
	   });  
	    //弹出系统按钮选择框
        var page=null; 
        page={ 
            imgUp:function(){ 
                var m=this; 
               /* console.log(m);*/
                plus.nativeUI.actionSheet({cancel:"取消",buttons:[ 
                    {title:"拍照"}, 
                    {title:"从相册中选择"} 
                ]}, function(e){//1 是拍照  2 从相册中选择 
                    switch(e.index){ 
                        case 1:appendByCamera();break; 
                        case 2:appendByGallery();break; 
                    } 
                }); 
            } 
        }
	    
	    $('#add_img').click(function(){
	    	page.imgUp();
		});
		function appendByCamera(){
			cameraimages();//拍照添加图片
		}
		function appendByGallery(){
			galleryImgs();//从相册选择照片
		}
		//图片上传
		mui.init();
		mui.plusReady(function() {})
		       //上传单张图片
		function galleryImg() {
		    //每次拍摄或选择图片前清空数组对象
		    f1.splice(0, f1.length);
		//          document.getElementsByClassName("showimg")[0].innerHTML = null;
		    // 从相册中选择图片
		    mui.toast("请从相册中选择图片");
		    plus.gallery.pick(function(path) {
		        showImg(path);
		    }, function(e) {
		        mui.toast("取消选择图片");
		    }, {
		        filter: "image",
		        multiple: false
		    });
		}
		
		function galleryImgs() {
		    //每次拍摄或选择图片前清空数组对象
		    f1.splice(0, f1.length);
			//document.getElementsByClassName("showimg")[0].innerHTML = null;
		    // 从相册中选择图片
		    mui.toast("请从相册中选择图片");
		    plus.gallery.pick(function(e) {
		    	
				//  if (e.files.length != 20) {
				//     mui.toast('请选择身份证正面和背面照片共两张');
				//     return false;
				//  }
		        for (var i in e.files) {
		            showImg(e.files[i]);
		        }
		    }, function(e) {
		        mui.toast("取消选择图片");
		    }, {
		        filter: "image",
		        multiple: true
		    });
		}
		        
		// 拍照添加文件
		function cameraimages() {
		    //每次拍摄或选择图片前清空数组对象
		    f1.splice(0, f1.length);
		//  document.getElementsByClassName("showimg")[0].innerHTML = null;
		    var cmr = plus.camera.getCamera();
		    cmr.captureImage(function(p) {
		        plus.io.resolveLocalFileSystemURL(p, function(entry) {
		            var localurl = entry.toLocalURL(); //把拍照的目录路径，变成本地url路径
		            showImg(localurl);
		        });
		    }, function(e) {
		        mui.toast("很抱歉，获取失败 ",e);
		    });
		}
		        
		// 全局数组对象，添加文件,用于压缩上传使用
		var f1 = new Array();
		var arr_src = [];
		function showImg(url) {
		    // 兼容以“file:”开头的情况
		    if (0 != url.toString().indexOf("file://")) {
		        url = "file://" + url;
		    }
		    var _div_ = document.getElementsByClassName("showimg")[0];
		    var _img_ = new Image();
		    _img_.className = 'pic_img';
		    _img_.src = url; // 传过来的图片路径在这里用。
		        _img_.onclick = function() {
		                plus.runtime.openFile(url);
		            };
		    _img_.onload = function() {
		        var tmph = _img_.height;
		        var tmpw = _img_.width;
		        var isHengTu = tmpw > tmph;
		        var max = Math.max(tmpw, tmph);
		        var min = Math.min(tmpw, tmph);
		        var bili = min / max;
		        if (max > 1200) {
		            max = 1200;
		            min = Math.floor(bili * max);
		        }
		        tmph = isHengTu ? min : max;
		        tmpw = isHengTu ? max : min;
		        _img_.style.border = "1px solid rgb(200,199,204)";
		        _img_.style.margin = "0.133333rem 0.133333rem 0 0";
		        _img_.style.width = "2.053333rem";
		        _img_.style.height = "2.053333rem";
		        _img_.onload = null;
		        plus.io.resolveLocalFileSystemURL(url, function(entry) {
		                entry.file(function(file) {
		                    console.log(file.size + '--' + file.name);
		                    canvasResize(file, {
		                        width: tmpw,
		                        height: tmph,
		                        crop: false,
		                        quality: 50, //压缩质量
		                        rotate: 0,
		                        callback: function(data, width, height) {
		                            f1.push(data);
		                            _img_.src = data;
		                            var oDiv = document.createElement('div');//新建元素
		                            var oSpan = document.createElement('span');
		                            oDiv.className = 'del_pic';//添加删除框样式
		                            oSpan.className = 'del_pic_btn';//添加删除按钮样式
		                            oSpan.innerText = '+';
		                            oSpan.addEventListener("click",fun1,false); 
		                            _div_.before(oDiv);//添加外层地v
		                            oDiv.appendChild(_img_);//图片显示到页面
		                            oDiv.appendChild(oSpan);//添加删除按钮
		                            plus.nativeUI.closeWaiting();
		                        }
		                    });
		                });
		            },
		            function(e) {
		                plus.nativeUI.closeWaiting();
		                console.log(e.message);
		            });
		    };
		};
		
		function imgupgrade() {
		    var wt = plus.nativeUI.showWaiting();
		    for(var i in f1){
		    	var  imgArray=[];//通过逗号分割到新的编码
		    	var newImgbase = f1[i].split(",")[1];
		        imgArray.push(newImgbase);//放到imgArray数组里面
		        picupload(imgArray,i);
		    }
		}
		
		function picupload(imgArray,num){
			mui.ajax(Interface_url + "/yhcms/web/jcsj/uploadPic.do",{
				data:{
					"parameters":{
						"smallPic":JSON.stringify(imgArray),
						"suffix":".jpeg"
					},
					"foreEndType":2,
					"code":"300000084"
				},
				dataType:'json',//服务器返回json格式数据
				type:'post',//HTTP请求类型
				timeout:10000,//超时时间设置为10秒；
				headers:{'Content-Type':'application/json'},	              
				success:function(data){
					//服务器返回响应，根据响应结果，分析是否登录成功；
					if(data.success){
						arr_src.push(data.data);
						if(num == f1.length-1){//图片上传完毕后关闭加载图标			
							plus.nativeUI.closeWaiting();
//							alert("上传成功");
						}
					}else{
						mui.alert("提示信息："+data.message, '提示', function(){});
					}
				   
				},
				error:function(xhr,type,errorThrown){
					//异常处理；
					console.log(type);
				}
			});
		}
		
		function fun1(){
			var img_src = $(this).parent().find('.pic_img').attr('src');//查找当前删除按钮下的图片地址
			for (var i=0; i<f1.length; i++) {//与数组图片地址进行对比删除
				if(f1[i] == img_src){
					f1.splice(i,1);
				}
			}
			$(this).parent().css('display','none');
		}
	</script>
	<script src="../js/lib/zxbx.js" type="text/javascript" charset="utf-8"></script>
</html>